#!/bin/sh

[[ -z "${POSTFIX_MYHOSTNAME}" ]] && {
  echo "FATAL: environment variable POSTFIX_MYHOSTNAME is not set"
  exit 1
}

cat <<EOT >>/etc/postfix/main.cf
maillog_file=/dev/stdout
myhostname = ${POSTFIX_MYHOSTNAME}
mydestination = \$mydomain
home_mailbox = Maildir/
mailbox_command = /usr/sbin/procmail
EOT

[[ -n "${POSTFIX_MYNETWORKS}" ]] && {
  echo "mynetworks = 127.0.0.1/8 ${POSTFIX_MYNETWORKS}" >>/etc/postfix/main.cf
}

cat <<EOT >/etc/postfix/aliases
MAILER-DAEMON: postmaster
postmaster: root
abuse: root
EOT

(
  cd /home
  find . -maxdepth 1 | while read entry; do
    entry="${entry/\.\//}"
    [[ "$entry" == '.' || "$entry" == '..' ]] && continue
    case $(stat -c '%F' "$entry") in
    'directory')
      adduser -h /home/"$entry" -s /sbin/nologin -u "$(stat -c '%u' "$entry")" -G users -D "$entry"
      ;;
    'symbolic link')
      echo "${entry}: "$(readlink "${entry}") >> /etc/postfix/aliases
      ;;
    esac
  done
)

newaliases

[[ "${WITH_OPENDKIM}" == "true" ]] && {
  __domain=$(echo "${POSTFIX_MYHOSTNAME}" | sed -e 's/^[^.]*\.//')
  mkdir -p /run/opendkim
  sed -i -e "s/example.com/${__domain}/" /etc/opendkim/opendkim.conf
  echo "InternalHosts ${POSTFIX_MYNETWORKS}" >>/etc/opendkim/opendkim.conf
  (
    echo "smtpd_milters = inet:127.0.0.1:8891"
    echo "non_smtpd_milters = $smtpd_milters milter_default_action = accept"
  ) >>/etc/postfix/main.cf
}

[[ "${WITH_SPAMASSASSIN}" == "true" ]] && {
  /usr/bin/sa-update
  /usr/sbin/spamd --daemonize
}

/usr/sbin/opendkim
/usr/sbin/postfix start-fg
